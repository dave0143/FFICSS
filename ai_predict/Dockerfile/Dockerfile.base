FROM nvcr.io/nvidia/l4t-base:r36.2.0

ENV DEBIAN_FRONTEND=noninteractive  
# ğŸ§  é—œé–‰äº’å‹•å¼å®‰è£

# å®‰è£ç³»çµ±å·¥å…·èˆ‡ä¾è³´
RUN apt-get update && apt-get install -y \
    python3-pip python3-dev python3-opencv \
    libsm6 libxext6 libglib2.0-0 libgl1-mesa-glx \
    ffmpeg curl unzip git vim && \
    apt-get clean

# æ›´æ–° pip
RUN pip3 install --upgrade pip

# å®‰è£ PyTorch + torchvisionï¼ˆJetPack 6 ç›¸å®¹ç‰ˆæœ¬ï¼‰
# ä»¥ä¸‹ç‚º Jetson å®˜æ–¹ wheel çš„å®‰è£æ–¹å¼
# ä¾†æºåƒè€ƒ: https://forums.developer.nvidia.com/t/pytorch-for-jetpack-6/283699

# æ›´æ–° pip
RUN pip3 install --upgrade pip

# å®‰è£ numpyï¼ˆæœ‰æ™‚ PyTorch å®‰è£å‰å…ˆè£å¥½æœƒç©©å®šï¼‰
RUN pip3 install numpy

# å®‰è£ PyTorch 2.1.0 wheelï¼ˆJetPack 6.0ï¼‰
#RUN pip3 install https://developer.download.nvidia.cn/compute/redist/jp/v60dp/pytorch/torch-2.2.0a0+6a974be.nv23.11-cp310-cp310-linux_aarch64.whl

# è¤‡è£½æœ¬æ©Ÿ PyTorch wheel é€²å®¹å™¨
COPY wheels/torch-2.3.0-cp310-cp310-linux_aarch64.whl .

# å®‰è£ PyTorchï¼ˆJetPack 6 ç›¸å®¹ .whlï¼‰
RUN pip3 install ./torch-2.3.0-cp310-cp310-linux_aarch64.whl


# è¤‡è£½ Jetson åŸç”Ÿçš„ CUDA .so æª”æ¡ˆé€²å®¹å™¨
COPY jetson_libs/ /usr/lib/aarch64-linux-gnu/

# ä¿®å¾© symbolic linkï¼ˆä¿éšªå†å»ºç«‹ä¸€æ¬¡ï¼‰
RUN ln -sf /usr/lib/aarch64-linux-gnu/libcublas.so.12.6.1.4 /usr/lib/aarch64-linux-gnu/libcublas.so.12 && \
    ln -sf /usr/lib/aarch64-linux-gnu/libcudart.so.12.6.68 /usr/lib/aarch64-linux-gnu/libcudart.so.12
# åŠ å…¥ cuDNN v9 çš„é€£çµï¼ˆè¦–ä½ ç‰ˆæœ¬å¯èƒ½æ˜¯ .9.3.0ï¼‰
RUN ln -sf /usr/lib/aarch64-linux-gnu/libcudnn.so.9.3.0 /usr/lib/aarch64-linux-gnu/libcudnn.so.9 && \
    ln -sf /usr/lib/aarch64-linux-gnu/libcudnn.so.9 /usr/lib/aarch64-linux-gnu/libcudnn.so

# è¨»å†Šå‹•æ…‹åº«è·¯å¾‘
RUN echo "/usr/lib/aarch64-linux-gnu" > /etc/ld.so.conf.d/jetson-cuda.conf && \
    ldconfig

# åŠ ç’°å¢ƒè®Šæ•¸ï¼ˆä¿éšªï¼‰
ENV LD_LIBRARY_PATH=/usr/lib/aarch64-linux-gnu:$LD_LIBRARY_PATH


RUN apt-get update && apt-get install -y libnvtoolsext1

WORKDIR /app
